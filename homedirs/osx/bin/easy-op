#!/usr/bin/env bash

set -e
set -o pipefail

[[ -z "${DEBUG}" ]] || set -x

main() {
  local sub_command
  sub_command="$1"
  case "$sub_command" in
    status)
      auth_check
      ;;
    list)
      list
      ;;
    show)
      shift
      show "$@"
      ;;
    *)
      print_usage_and_exit
      ;;
  esac
}

print_usage_and_exit() {
  echo "
usage: $0 <command>

1password CLI without all the JSON parsing

Commands:
 - status
     checks if your terminal session has a valid token

 - list
     displays some stats of the whole dataset

 - show <title> <field>
     displays a credential (only works with secure notes)
"
  exit 1
}

auth_check() {
  if op list vaults > /dev/null 2>&1
  then
    echo "authenticated"; exit 0
  else
    echo "unauthenticated"; exit 1
  fi
}

show() {
  local title="$1"
  local section="$2"

  op get item "${title}" \
     | jq -r ".details.sections[]
       | select(.fields)
       | .fields[]
       | select(.t == \"${section}\")
       | .v"
}

list() {
  op list items | jq -r .[].overview.title | sort -f
}

main "$@"
