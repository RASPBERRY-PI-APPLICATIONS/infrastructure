#!/usr/bin/env bash

set -e
set -o pipefail

main() {
  case "$1" in
    load)
      shift
      load_command "$@"
      ;;
    *)
      print_usage_and_exit
      ;;
  esac
}

load_command() {
  local note_name="keychain"
  local field_name="base64 encoded ssh private key"
  local timeout="1"

  while getopts ":n:t:f:" opt; do
    case $opt in
      n) note_name="$OPTARG"
      ;;
      f) field_name="$OPTARG"
      ;;
      t) timeout="$OPTARG"
      ;;
      \?) print_usage_and_exit
      ;;
    esac
  done

  load "${note_name}" "${field_name}" "${timeout}"
}

load() {
  # Assuming default values have been passed in
  local note_name="$1"
  local field_name="$2"
  local timeout="$3"

  timeout_in_seconds="$(echo "${timeout}*3600" | bc)"

  echo "Adding \"${note_name}\".\"${field_name}\" to your ssh-agent for ${timeout} hour(s)"
  local base64_key="$(easy-op show -n "${note_name}" -f "${field_name}")"
  local decoded_key="$(echo "${base64_key}" | base64 -D)"
  ssh-add -t "${timeout_in_seconds}" - <<< "$(echo -e "${decoded_key}")"
}

print_usage_and_exit() {
  cat <<USAGE
usage: $0 <command>

Grabs ssh keys from 1 Password and stores them in your ssh-agent. Currently
this only works with Secure Notes because of the way 1 Password structures
its data internally.

Commands:
 - load
     adds a secure note into your ssh-agent

     -n      specify the name of the item (default: "keychain")

     -f      specify the field of the key; needs to be base64 encoded (default: "base64 encoded ssh private key")

     -t      specify a timeout in hrs (default: 1)

Examples:

ssh_op_agent load -n test -f "base64 encoded ssh private key"
ssh_op_agent load -n test
USAGE

  exit 1
}

main "$@"
