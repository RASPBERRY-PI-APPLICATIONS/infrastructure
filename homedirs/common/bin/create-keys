#!/usr/bin/env bash

set -eu
set -o pipefail

[[ -z "${DEBUG:-}" ]] || set -x

main() {
  local secret_title
  local ssh_key_passphrase
  local private_key
  local public_key
  local temp_dir
  local github_token
  secret_title="${1:-}"

  if [[ -z "${secret_title}" || "${secret_title}" = "-h" ]]; then
    print_usage_and_exit
  fi

  log_into_1password

  ssh_key_passphrase="$(xkcd-password-generator)"
  temp_dir=$(mktemp -d -t tmp.XXXXXXXXXX)
  # we want to the value of temp_dir
  # shellcheck disable=SC2064
  trap "cleanup ${temp_dir}" EXIT
  ssh-keygen -t ed25519 -C "${secret_title}" -f "${temp_dir}/id_ed25519" -N "${ssh_key_passphrase}"
  private_key=$(jq -n --arg key "$(cat "${temp_dir}/id_ed25519")" '{ test: $key }' | jq .test | tr  -d '"')
  public_key=$(cat "${temp_dir}/id_ed25519.pub")

  github_token=$(op read op://Automation/github-ssh-key-rotator/token)

  curl https://api.github.com/user/keys \
    -X POST \
    -H "Authorization: token ${github_token}" \
    -d "{ \"title\": \"${secret_title}\", \"key\": \"${public_key}\" }"

  IFS='' read -r -d '' credential_json <<JSON ||
{
  "fields": [
    {
      "id": "base64 encoded ssh private key",
      "type": "concealed",
      "label": "base64 encoded ssh private key",
      "value": "$(echo "${private_key}" | base64 | xargs | sed 's/ //g' )"
    },
    {
      "id": "ssh key passphrase",
      "type": "concealed",
      "label": "ssh key passphrase",
      "value": "${ssh_key_passphrase}"
    },
    {
      "id": "notesPlain",
      "type": "STRING",
      "purpose": "NOTES",
      "label": "notesPlain",
      "value": "generated by \`create-keys\` \n\n

source: https://github.com/scottmuc/infrastructure/blob/main/homedirs/common/bin/create-keys
"
    }
  ]
}
JSON
  true

  # purposefully not quoting a variable to prevent linebreaks from rendering
  # shellcheck disable=SC2086
  op item create \
    --category="Secure Note" \
    --vault="Automation" \
    --title="${secret_title}" \
    --template=<(echo ${credential_json})
}

print_usage_and_exit() {
  cat <<HELP
usage: $0 <name of credential>

Generates the following:

  - ed25519 key protected with a passphrase
  - Public key reference in GitHub

The private key, and all the passphrases will be stored in a 1Password
"Secure Note" with the name provided.

HELP

  exit 1
}

log_into_1password() {
  eval "$(op signin)"
}

cleanup() {
  dir_to_cleanup="$1"

  if [[ -d "${dir_to_cleanup}" ]]; then
    rm -rf "${dir_to_cleanup}"
  fi
}

main "$@"
