- name: Install certbot package
  apt:
    name: certbot

# I've elected to disable automated renewals. This requires different
# logic for renewing a certificate than creating new a new one. Rather
# than renew certificates, I use the e-mail notification from letsencrypt
# as cue to repave the PI. This ensures that the bootstrapping process
# just works.
#
# ref: https://eff-certbot.readthedocs.io/en/stable/using.html#automated-renewals
- name: Disable certbot.timer
  service:
    name: certbot.timer
    enabled: false
    state: stopped


# The logic for when this needs to happen is the following:
# - when the complete set of certificates aren't fetched
# - and when nginx is actually installed (ordering problem)
#
# The starting of nginx is left to the nginx_tasks.yml
#
# An alternative is to setup nginx so that the ACME challenge known pathes are
# configured correctly so that the --standalone argument isn't used with certbot.
- name: Ensure nginx is stopped before certbot interactions
  service:
    name: nginx
    state: stopped


# TODO: use full names of certbot args
#       inject fqdns from the playbook
- name: Acquire certificates
  command: |
    certbot certonly --standalone --non-interactive --agree-tos
    -d {{ item.fqdn }} \
    -m "scottmuc@gmail.com"
  args:
    creates: /etc/letsencrypt/live/{{ item.fqdn }}/fullchain.pem
  loop:
    - fqdn: www.goodenoughmoney.com
    - fqdn: home.scottmuc.com
