---
- hosts: all
  remote_user: pi
  gather_facts: false
  become: true

  pre_tasks:
    - name: attempt to update apt's cache
      apt:
        update_cache: true

  tasks:
    - name: Create admin user group
      group:
        name: admin
        system: true
        state: present

    # The Raspberry PI OS image comes with sudo installed, but will leave this
    # check here just in case that assumption changes.
    - name: Ensure sudo is installed
      package:
        name: sudo
        state: present

    - name: Create Ansible user
      user:
        name: ansible
        shell: /bin/bash
        comment: "Ansible management user"
        home: /home/ansible
        createhome: true

    - name: Add Ansible user to admin group
      user:
        name: ansible
        groups: admin
        append: true

    # https://stackoverflow.com/a/62459797
    - name: Ensure admin group can sudo
      copy:
        state: present
        dest: /etc/sudoers.d/admin-group-nopasswd
        owner: root
        group: root
        mode: '0440'
        content: |
          '%admin ALL=(ALL) NOPASSWD: ALL'

    - name: Add authorized keys
      authorized_key:
        user: ansible
        state: present
        key: https://github.com/scottmuc.keys
