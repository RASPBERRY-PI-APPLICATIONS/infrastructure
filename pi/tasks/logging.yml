# TLS info came from:
# https://www.papertrail.com/help/encrypting-remote-syslog-with-tls-ssl/
# TODO: revisit how variables get defined here
- name: Include vars
  include_vars:
    file: secret_vars.yml
    name: secrets

- name: Ensure required packages are installed
  apt:
    name: rsyslog-gnutls

- name: Add papertrail CA
  become: true
  get_url:
    dest: /etc/papertrail-bundle.pem
    owner: root
    group: admin
    mode: '0664'
    url: https://papertrailapp.com/tools/papertrail-bundle.pem


- name: Add Papertrail forwarding configuration
  become: true
  copy:
    dest: /etc/rsyslog.d/papertrail.conf
    content: |
      $DefaultNetstreamDriverCAFile /etc/papertrail-bundle.pem
      $ActionSendStreamDriver gtls
      $ActionSendStreamDriverMode 1
      $ActionSendStreamDriverAuthMode x509/name
      $ActionSendStreamDriverPermittedPeer *.papertrailapp.com

      *.* action(type="omfwd"
                 target="{{ secrets.rsyslog_forwarding_target }}"
                 port="{{ secrets.rsyslog_forwarding_port }}"
                 protocol="tcp")
    owner: root
    group: admin
    mode: '0640'
  notify:
    - Restart rsyslog
