- name: Install nginx package
  apt:
    name: nginx


# Look at replacing this with adding a file to
# /etc/nginx/conf.d
- name: Increase server_names_hash_bucket_size in nginx.conf
  lineinfile:
    path: /etc/nginx/nginx.conf
    insertafter: "^http {"
    line: "server_names_hash_bucket_size 64;"
  notify:
    - Restart nginx


- name: Setup www.goodenoughmoney.com home
  file:
    path: /opt/goodenoughmoney
    state: directory
    owner: root
    group: admin
    mode: '0775'


- name: Install vhost configs
  copy:
    src: root/etc/nginx/sites-available/{{ item.vhost }}
    dest: /etc/nginx/sites-available/{{ item.vhost }}
    owner: root
    group: admin
    mode: '0664'
  notify:
    - Restart nginx
  loop:
    - vhost: goodenoughmoney.com
    - vhost: home.scottmuc.com


- name: Enable vhosts
  file:
    src: /etc/nginx/sites-available/{{ item.vhost }}
    dest: /etc/nginx/sites-enabled/{{ item.vhost }}
    state: link
  loop:
    - vhost: goodenoughmoney.com
    - vhost: home.scottmuc.com


- name: Enable stub_status
  copy:
    src: root/etc/nginx/conf.d/status.conf
    dest: /etc/nginx/conf.d/status.conf
    owner: root
    group: admin
    mode: '0664'
  tags:
    - wip
  notify:
    - Restart nginx


# Are there trade-offs when ensuring a started and enabled state
# in the same task?
- name: Start nginx
  service:
    name: nginx
    state: started
    enabled: true
