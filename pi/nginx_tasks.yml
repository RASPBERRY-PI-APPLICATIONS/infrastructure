- name: Install nginx package
  apt: pkg=nginx

- name: Install certbot package
  apt: pkg=certbot


# Make this happen only if neither certificates exist
- name: Ensure nginx is stopped before certbot interactions
  service:
    name: nginx
    state: stopped


- name: Increase server_names_hash_bucket_size in nginx.conf
  lineinfile:
    path: /etc/nginx/nginx.conf
    insertafter: "^http {"
    line: "server_names_hash_bucket_size 64;"
  notify:
    - Restart nginx


- name: Disable certbot.timer
  service:
    name: certbot.timer
    enabled: false
    state: stopped


- name: Acquire certificate for www.goodenoughmoney.com
  command: |
    certbot certonly --standalone -d www.goodenoughmoney.com \
    --non-interactive --agree-tos -m "scottmuc@gmail.com"
  args:
    creates: /etc/letsencrypt/live/www.goodenoughmoney.com/fullchain.pem


- name: Setup www.goodenoughmoney.com home
  file:
    path: /opt/goodenoughmoney
    state: directory
    owner: root
    group: admin
    mode: '0775'


- name: Install www.goodenoughmoney.com config
  copy:
    src: root/etc/nginx/sites-available/goodenoughmoney.com
    dest: /etc/nginx/sites-available/goodenoughmoney.com
    owner: root
    group: admin
    mode: '0664'
  notify:
    - Restart nginx


- name: Enable www.goodenoughmoney.com
  file:
    src: /etc/nginx/sites-available/goodenoughmoney.com
    dest: /etc/nginx/sites-enabled/goodenoughmoney.com
    state: link


- name: Acquire certificate for home.scottmuc.com
  command: |
    certbot certonly --standalone -d home.scottmuc.com \
    --non-interactive --agree-tos -m "scottmuc@gmail.com"
  args:
    creates: /etc/letsencrypt/live/home.scottmuc.com/fullchain.pem


- name: Install home.scottmuc.com config
  copy:
    src: root/etc/nginx/sites-available/home.scottmuc.com
    dest: /etc/nginx/sites-available/home.scottmuc.com
    owner: root
    group: admin
    mode: '0664'
  notify:
    - Restart nginx


- name: Enable home.scottmuc.com
  file:
    src: /etc/nginx/sites-available/home.scottmuc.com
    dest: /etc/nginx/sites-enabled/home.scottmuc.com
    state: link


- name: Enable stub_status
  copy:
    src: root/etc/nginx/conf.d/status.conf
    dest: /etc/nginx/conf.d/status.conf
    owner: root
    group: admin
    mode: '0664'
  tags:
    - wip
  notify:
    - Restart nginx


- name: Start nginx
  service:
    name: nginx
    state: started
    enabled: true
